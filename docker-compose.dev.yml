# ============================================================================
# docker-compose.dev.yml - Configuration pour d√©veloppement avec hot reload
# ============================================================================
#
# Utilisation:
#   docker compose -f docker-compose.dev.yml up -d
#
# Avantages:
#   - Code source mont√© en volume ‚Üí Modifications sans rebuild
#   - FastAPI hot reload activ√© ‚Üí Red√©marrage automatique
#   - Logs et donn√©es persistantes
#
# Limitations:
#   - Utilis√© pour d√©veloppement uniquement (pas pour production)
#   - N√©cessite que l'image soit d√©j√† build√©e une fois
#   - Debugging plus compliqu√© (dans le conteneur)
#
# ============================================================================

services:
  fedgesrv:
    # Build initial (n√©cessaire une seule fois)
    build:
      context: .
      dockerfile: Dockerfile.cpu-full
    image: fedgesrv:dev
    network_mode: host
    restart: unless-stopped

    # VOLUMES - CODE SOURCE MONT√â
    volumes:
      # ‚úÖ Donn√©es persistantes (comme docker-compose.yml)
      - ./logs:/app/logs
      - ./data:/app/data
      - ./cache:/app/cache
      - ./config:/app/config

      # üÜï CODE SOURCE MONT√â (changements sans rebuild!)
      - ./backend:/app/backend
      - ./frontend:/app/frontend

      # Scripts et config
      - ./run_server.py:/app/run_server.py
      - ./start_llamacpp.sh:/app/start_llamacpp.sh
      - ./entrypoint.sh:/app/entrypoint.sh

      # Config files (si tu veux les modifier sans rebuild)
      # - ./requirements.txt:/app/requirements.txt  # ‚ö†Ô∏è Rebuild n√©cessaire si modifi√©

    # Environment variables pour d√©veloppement
    environment:
      - PYTHONUNBUFFERED=1          # Pas de buffering des logs Python
      - RELOAD=true                 # Flag custom (si ton entrypoint.sh le supporte)
      - LOG_LEVEL=DEBUG             # Plus de logs en dev

    # ‚ö° HOT RELOAD activ√© via uvicorn --reload
    command: >
      bash -c "
      echo 'üîß Mode d√©veloppement avec hot reload activ√©';

      # D√©marrer llama.cpp servers en background
      ./start_llamacpp.sh &

      # Attendre que llama.cpp d√©marre (optionnel)
      sleep 5;

      # Activer le venv et d√©marrer FastAPI avec hot reload
      source /app/venv/bin/activate &&
      uvicorn backend.main:app \
        --reload \
        --host 0.0.0.0 \
        --port 8000 \
        --log-level debug
      "

    # Healthcheck (optionnel)
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
